
<script>
  /**
   * Huisarts Check - Client-side JavaScript
   * 
   * Dit bestand bevat alle client-side functionaliteit voor de Huisarts Check applicatie.
   * Vereenvoudigde versie voor betere compatibiliteit met Apps Script.
   */

  // Globale variabelen
  let currentUser = null;
  let isAdmin = false;
  
  /**
   * Bij laden van de pagina
   */
  document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM geladen, applicatie initialiseren");
    initApp();
  });
  
  /**
   * Applicatie-initialisatie
   */
  function initApp() {
    console.log("App initialisatie gestart");
    
    // Toon loading indicator
    showLoading(true);
    
    // Controleer of gebruiker gegevens al in template zijn ingesteld
    if (typeof user !== 'undefined' && user) {
      console.log("Gebruiker gevonden in template data");
      currentUser = user;
      isAdmin = !!isAdmin;
      initializeUserInterface();
    } else {
      console.log("Geen gebruiker in template, authenticatie controleren");
      checkAuthentication();
    }
  }
  
  /**
   * Controleert de authenticatiestatus
   */
  function checkAuthentication() {
    console.log("Authenticatie controleren");
    showLoading(true);
    
    try {
      google.script.run
        .withSuccessHandler(function(authStatus) {
          console.log("Authenticatieresultaat ontvangen", authStatus);
          
          if (!authStatus) {
            console.error("Authenticatiestatus is null of undefined");
            showError("Authenticatiestatus is null of undefined. Probeer de pagina te vernieuwen of log opnieuw in.");
            return;
          }
          
          if (authStatus.loggedIn === true && authStatus.user) {
            console.log("Gebruiker is ingelogd");
            currentUser = authStatus.user;
            isAdmin = !!authStatus.isAdmin;
            initializeUserInterface();
          } else if (authStatus.authUrl) {
            console.log("Gebruiker niet ingelogd, doorverwijzen naar login");
            window.top.location.href = authStatus.authUrl;
          } else if (authStatus.errorMessage) {
            console.error("Authenticatiefout: " + authStatus.errorMessage);
            showError("Authenticatiefout: " + authStatus.errorMessage);
          } else {
            console.error("Onbekende authenticatiestatus");
            showError("Authenticatiefout: Onbekende status. Probeer de pagina te vernieuwen.");
          }
        })
        .withFailureHandler(function(error) {
          console.error("Authenticatie mislukt: ", error);
          showError("Authenticatiefout: " + error);
        })
        .checkLoginStatus();
    } catch (error) {
      console.error("Fout bij aanroepen authenticatie: ", error);
      showError("Kon niet verbinden met de server: " + error);
    }
  }
  
  /**
   * Initialiseert de gebruikersinterface
   */
  function initializeUserInterface() {
    console.log("UI initialiseren voor gebruiker: " + (currentUser ? currentUser.email : "onbekend"));
    
    try {
      if (!currentUser) {
        console.error("Geen geldige gebruikersgegevens voor UI initialisatie");
        showError("Geen geldige gebruikersgegevens. Probeer opnieuw in te loggen.");
        return;
      }
      
      // Verberg loading indicator
      showLoading(false);
      
      // Dashboard laden
      loadDashboard();
    } catch (error) {
      console.error("Fout bij initialiseren UI: ", error);
      showError("Fout bij laden interface: " + error);
    }
  }
  
  /**
   * Laadt het dashboard
   */
  function loadDashboard() {
    console.log("Dashboard laden");
    
    // Verkrijg referentie naar content container
    const contentContainer = document.getElementById('content');
    if (!contentContainer) {
      console.error("Content container niet gevonden");
      showError("Content container niet gevonden in DOM");
      return;
    }
    
    contentContainer.style.display = 'block';
    
    // Voeg basis dashboard elementen toe
    let dashboardHTML = `
      <div class="dashboard-header">
        <h2>Welkom, ${currentUser.naam || currentUser.email.split('@')[0]}</h2>
        <p>U bent ingelogd als ${currentUser.email}</p>
      </div>
      
      <div class="dashboard-tabs">
        <button class="tab-button active" data-tab="my-practices">Mijn Huisartsen</button>
        <button class="tab-button" data-tab="add-practice">Toevoegen</button>
        <button class="tab-button" data-tab="settings">Instellingen</button>
      </div>
      
      <div class="tab-content">
        <div id="my-practices" class="tab-pane active">
          <h3>Mijn Huisartsen</h3>
          <div id="practices-list" class="practices-list">
            <div class="spinner"></div>
            <p>Praktijken laden...</p>
          </div>
        </div>
        
        <div id="add-practice" class="tab-pane">
          <h3>Huisarts Toevoegen</h3>
          <form id="add-practice-form">
            <div class="form-group">
              <label for="practice-name">Naam van de praktijk:</label>
              <input type="text" id="practice-name" name="naam" required>
            </div>
            <div class="form-group">
              <label for="practice-url">Website URL:</label>
              <input type="url" id="practice-url" name="websiteUrl" required placeholder="https://www.huisarts-voorbeeld.nl">
            </div>
            <div class="form-group">
              <label for="practice-notes">Notities:</label>
              <textarea id="practice-notes" name="notes" rows="3"></textarea>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-primary">Toevoegen</button>
            </div>
          </form>
        </div>
        
        <div id="settings" class="tab-pane">
          <h3>Instellingen</h3>
          <form id="settings-form">
            <div class="form-group">
              <label for="user-name">Naam:</label>
              <input type="text" id="user-name" name="naam" value="${currentUser.naam || ''}">
            </div>
            <div class="form-group">
              <label class="checkbox-label">
                <input type="checkbox" name="notificationsEnabled" ${currentUser.notificationsEnabled ? 'checked' : ''}>
                E-mailnotificaties ontvangen
              </label>
            </div>
            <div class="form-group">
              <label for="check-frequency">Controlefrequentie:</label>
              <select id="check-frequency" name="checkFrequency">
                <option value="daily" ${currentUser.checkFrequency === 'daily' ? 'selected' : ''}>Dagelijks</option>
                <option value="weekly" ${currentUser.checkFrequency === 'weekly' ? 'selected' : ''}>Wekelijks</option>
                <option value="monthly" ${currentUser.checkFrequency === 'monthly' ? 'selected' : ''}>Maandelijks</option>
              </select>
            </div>
            <div class="form-actions">
              <button type="submit" class="btn-primary">Opslaan</button>
            </div>
          </form>
        </div>
      </div>
    `;
    
    // Voeg admin panel toe indien van toepassing
    if (isAdmin) {
      const adminHTML = `
        <div class="admin-panel">
          <h3>Admin Paneel</h3>
          <p>U heeft toegang tot admin functionaliteit.</p>
          <div class="admin-buttons">
            <button id="btn-admin-users" class="admin-button">Gebruikersbeheer</button>
            <button id="btn-admin-logs" class="admin-button">Logboek bekijken</button>
          </div>
        </div>
      `;
      
      // Voeg admin panel toe aan begin van dashboard
      dashboardHTML = adminHTML + dashboardHTML;
    }
    
    // Zet de HTML in de content container
    contentContainer.innerHTML = dashboardHTML;
    
    // Setup eventhandlers
    setupEventHandlers();
    
    // Laad praktijken
    loadPracticesList();
  }
  
  /**
   * Registreert event handlers
   */
  function setupEventHandlers() {
    console.log("Event handlers registreren");
    
    // Tab navigatie
    const tabButtons = document.querySelectorAll('.tab-button');
    if (tabButtons && tabButtons.length > 0) {
      tabButtons.forEach(button => {
        button.addEventListener('click', function() {
          const tabId = this.dataset.tab;
          console.log("Tab " + tabId + " aangeklikt");
          
          // Deactiveer alle tabs
          document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
          document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
          
          // Activeer geselecteerde tab
          this.classList.add('active');
          const selectedPane = document.getElementById(tabId);
          if (selectedPane) {
            selectedPane.classList.add('active');
          }
        });
      });
    }
    
    // Formulier handlers
    const addPracticeForm = document.getElementById('add-practice-form');
    if (addPracticeForm) {
      addPracticeForm.addEventListener('submit', function(e) {
        e.preventDefault();
        handleAddPracticeSubmit(this);
      });
    }
    
    const settingsForm = document.getElementById('settings-form');
    if (settingsForm) {
      settingsForm.addEventListener('submit', function(e) {
        e.preventDefault();
        handleSettingsSubmit(this);
      });
    }
    
    // Admin handlers indien van toepassing
    if (isAdmin) {
      const usersButton = document.getElementById('btn-admin-users');
      if (usersButton) {
        usersButton.addEventListener('click', function() {
          showNotification("Gebruikersbeheer functionaliteit wordt binnenkort ge√Ømplementeerd");
        });
      }
      
      const logsButton = document.getElementById('btn-admin-logs');
      if (logsButton) {
        logsButton.addEventListener('click', function() {
          showNotification("Logboek bekijken functionaliteit wordt binnenkort ge√Ømplementeerd");
        });
      }
    }
  }
  
  /**
   * Laadt de lijst met praktijken
   */
  function loadPracticesList() {
    console.log("Praktijkenlijst laden");
    
    const practicesList = document.getElementById('practices-list');
    if (!practicesList) {
      console.error("Praktijkenlijst element niet gevonden");
      return;
    }
    
    // Toon loading indicator
    practicesList.innerHTML = '<div class="spinner"></div><p>Praktijken laden...</p>';
    
    try {
      google.script.run
        .withSuccessHandler(function(practices) {
          console.log("Praktijken ontvangen: " + (practices ? practices.length : 0));
          
          if (!practices || practices.length === 0) {
            practicesList.innerHTML = `
              <div class="empty-state">
                <p>U heeft nog geen huisartsenpraktijken toegevoegd.</p>
                <p>Ga naar de "Toevoegen" tab om te beginnen.</p>
              </div>
            `;
            return;
          }
          
          // Bouw de praktijkenlijst
          let listHtml = '<div class="practices-grid">';
          
          practices.forEach(practice => {
            // Status bepalen
            let statusClass = 'status-unknown';
            let statusText = 'Onbekend';
            
            if (practice.currentStatus === 'ja') {
              statusClass = 'status-accepting';
              statusText = 'Neemt pati√´nten aan';
            } else if (practice.currentStatus === 'nee') {
              statusClass = 'status-not-accepting';
              statusText = 'Neemt geen pati√´nten aan';
            }
            
            // Praktijk toevoegen
            listHtml += `
              <div class="practice-card">
                <h4>${practice.naam}</h4>
                <div class="practice-status ${statusClass}">
                  <span>${statusText}</span>
                </div>
                <div class="practice-url">
                  <a href="${practice.websiteUrl}" target="_blank">${practice.websiteUrl}</a>
                </div>
                <div class="practice-actions">
                  <button class="btn-check" data-id="${practice.practiceId}">Controleren</button>
                  <button class="btn-edit" data-id="${practice.practiceId}">Bewerken</button>
                  <button class="btn-delete" data-id="${practice.practiceId}">Verwijderen</button>
                </div>
              </div>
            `;
          });
          
          listHtml += '</div>';
          
          // Zet de HTML in de container
          practicesList.innerHTML = listHtml;
          
          // Voeg handlers toe voor de knoppen
          setupPracticeActionHandlers();
        })
        .withFailureHandler(function(error) {
          console.error("Fout bij laden praktijken: ", error);
          
          practicesList.innerHTML = `
            <div class="error-state">
              <p>Er is een fout opgetreden bij het ophalen van uw huisartsenpraktijken:</p>
              <p>${error}</p>
              <button onclick="loadPracticesList()">Opnieuw proberen</button>
            </div>
          `;
        })
        .getPracticesByUser(currentUser.userId);
    } catch (error) {
      console.error("Fout bij aanroepen getPracticesByUser: ", error);
      practicesList.innerHTML = `
        <div class="error-state">
          <p>Kon geen verbinding maken met de server:</p>
          <p>${error}</p>
          <button onclick="loadPracticesList()">Opnieuw proberen</button>
        </div>
      `;
    }
  }
  
  /**
   * Registreert handlers voor praktijk acties
   */
  function setupPracticeActionHandlers() {
    console.log("Praktijk actie handlers registreren");
    
    // Check buttons
    document.querySelectorAll('.btn-check').forEach(button => {
      button.addEventListener('click', function() {
        handleCheckPractice(this.dataset.id);
      });
    });
    
    // Edit buttons
    document.querySelectorAll('.btn-edit').forEach(button => {
      button.addEventListener('click', function() {
        handleEditPractice(this.dataset.id);
      });
    });
    
    // Delete buttons
    document.querySelectorAll('.btn-delete').forEach(button => {
      button.addEventListener('click', function() {
        handleDeletePractice(this.dataset.id);
      });
    });
  }
  
  /**
   * Handler voor het toevoegen van een praktijk
   */
  function handleAddPracticeSubmit(form) {
    console.log("Praktijk toevoegen formulier verzonden");
    
    // Formulierdata verzamelen
    const formData = {
      userId: currentUser.userId,
      naam: form.elements.naam.value,
      websiteUrl: form.elements.websiteUrl.value,
      notes: form.elements.notes.value || ''
    };
    
    // Valideer formulierdata
    if (!formData.naam || !formData.websiteUrl) {
      showError("Vul alle verplichte velden in");
      return;
    }
    
    // Submit knop uitschakelen
    const submitButton = form.querySelector('button[type="submit"]');
    if (submitButton) {
      submitButton.disabled = true;
      submitButton.textContent = 'Toevoegen...';
    }
    
    try {
      google.script.run
        .withSuccessHandler(function(result) {
          console.log("Praktijk succesvol toegevoegd");
          
          // Reset formulier
          form.reset();
          
          // Schakel submit knop weer in
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Toevoegen';
          }
          
          // Ga terug naar praktijkenlijst tab
          document.querySelector('.tab-button[data-tab="my-practices"]').click();
          
          // Ververs praktijkenlijst
          loadPracticesList();
          
          // Toon bevestiging
          showNotification("Huisartsenpraktijk succesvol toegevoegd");
        })
        .withFailureHandler(function(error) {
          console.error("Fout bij toevoegen praktijk: ", error);
          
          // Schakel submit knop weer in
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Toevoegen';
          }
          
          // Toon foutmelding
          showError("Fout bij toevoegen: " + error);
        })
        .createPractice(formData);
    } catch (error) {
      console.error("Fout bij aanroepen createPractice: ", error);
      // Schakel submit knop weer in
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.textContent = 'Toevoegen';
      }
      
      // Toon foutmelding
      showError("Fout bij toevoegen: " + error);
    }
  }
  
  /**
   * Handler voor het bewerken van instellingen
   */
  function handleSettingsSubmit(form) {
    console.log("Instellingen formulier verzonden");
    
    // Formulierdata verzamelen
    const formData = {
      naam: form.elements.naam.value || '',
      notificationsEnabled: form.elements.notificationsEnabled.checked,
      checkFrequency: form.elements.checkFrequency.value
    };
    
    // Submit knop uitschakelen
    const submitButton = form.querySelector('button[type="submit"]');
    if (submitButton) {
      submitButton.disabled = true;
      submitButton.textContent = 'Opslaan...';
    }
    
    try {
      google.script.run
        .withSuccessHandler(function(updatedUser) {
          console.log("Instellingen succesvol bijgewerkt");
          
          // Update gebruikersgegevens
          if (updatedUser) {
            currentUser = updatedUser;
          }
          
          // Schakel submit knop weer in
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Opslaan';
          }
          
          // Toon bevestiging
          showNotification("Instellingen succesvol opgeslagen");
        })
        .withFailureHandler(function(error) {
          console.error("Fout bij opslaan instellingen: ", error);
          
          // Schakel submit knop weer in
          if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Opslaan';
          }
          
          // Toon foutmelding
          showError("Fout bij opslaan: " + error);
        })
        .updateCurrentUserSettings(formData);
    } catch (error) {
      console.error("Fout bij aanroepen updateCurrentUserSettings: ", error);
      // Schakel submit knop weer in
      if (submitButton) {
        submitButton.disabled = false;
        submitButton.textContent = 'Opslaan';
      }
      
      // Toon foutmelding
      showError("Fout bij opslaan: " + error);
    }
  }
  
  /**
   * Handler voor het controleren van een praktijk
   */
  function handleCheckPractice(practiceId) {
    console.log("Controleren praktijk: " + practiceId);
    
    showNotification("Controle starten voor praktijk...");
    
    try {
      google.script.run
        .withSuccessHandler(function(result) {
          console.log("Controleresultaat ontvangen", result);
          
          if (result && result.success) {
            showNotification("Controle voltooid: " + (result.message || "Status bijgewerkt"));
            loadPracticesList();
          } else {
            showError("Controle mislukt: " + (result && result.message ? result.message : "Onbekende fout"));
          }
        })
        .withFailureHandler(function(error) {
          console.error("Fout bij controleren praktijk: ", error);
          showError("Fout bij controleren: " + error);
        })
        .checkPracticeNow(practiceId);
    } catch (error) {
      console.error("Fout bij aanroepen checkPracticeNow: ", error);
      showError("Fout bij controleren: " + error);
    }
  }
  
  /**
   * Handler voor het bewerken van een praktijk
   */
  function handleEditPractice(practiceId) {
    console.log("Bewerken praktijk: " + practiceId);
    showNotification("Bewerken functionaliteit wordt binnenkort ge√Ømplementeerd");
  }
  
  /**
   * Handler voor het verwijderen van een praktijk
   */
  function handleDeletePractice(practiceId) {
    console.log("Verwijderen praktijk: " + practiceId);
    
    if (confirm("Weet u zeker dat u deze huisartsenpraktijk wilt verwijderen?")) {
      try {
        google.script.run
          .withSuccessHandler(function(success) {
            console.log("Verwijderen praktijk resultaat: " + success);
            
            if (success) {
              loadPracticesList();
              showNotification("Huisartsenpraktijk succesvol verwijderd");
            } else {
              showError("Kon de huisartsenpraktijk niet verwijderen");
            }
          })
          .withFailureHandler(function(error) {
            console.error("Fout bij verwijderen praktijk: ", error);
            showError("Fout bij verwijderen: " + error);
          })
          .deletePractice(practiceId);
      } catch (error) {
        console.error("Fout bij aanroepen deletePractice: ", error);
        showError("Fout bij verwijderen: " + error);
      }
    }
  }
  
  /**
   * Toont of verbergt de laad-indicator
   */
  function showLoading(show) {
    console.log("Loading indicator: " + (show ? "tonen" : "verbergen"));
    
    const loading = document.getElementById('loading');
    if (!loading) {
      console.error("Loading element niet gevonden");
      return;
    }
    
    if (show) {
      loading.style.display = 'block';
    } else {
      loading.style.display = 'none';
    }
  }
  
  /**
   * Toont een foutmelding
   * Verbeterde implementatie die beter omgaat met verschillende datatypes en HTML elementen
   * Met speciale aandacht voor null-waarden en meer informatieve meldingen
   */
  function showError(message) {
    // Log de foutmelding inclusief type en ruwe waarde voor diagnostiek
    console.error("Foutmelding:", message, "Type:", typeof message, 
                  "ToString:", message !== null && message !== undefined ? message.toString() : "null/undefined");
    
    const errorContainer = document.getElementById('error');
    const errorMessage = document.getElementById('error-message');
    
    if (!errorContainer || !errorMessage) {
      console.error("Error container of message element niet gevonden");
      // Toon alert als fallback, maar voorkom "null" melding
      const alertMessage = message !== null && message !== undefined && typeof message.toString === 'function' ? 
                           message.toString() : "Er is een onbekende fout opgetreden";
      alert("Fout: " + alertMessage);
      return;
    }
    
    // Veilige string conversie voor verschillende foutobjecttypes
    let errorText = "Er is een fout opgetreden";
    
    try {
      if (message === null || message === undefined) {
        // Verbeterde afhandeling van null/undefined waarden
        errorText = "Er is een onbekende fout opgetreden. Probeer de pagina te vernieuwen of probeer het later opnieuw.";
        
        // Voeg stack trace informatie toe voor debugging
        console.debug("Stack trace voor null foutmelding:", new Error().stack);
      } else if (typeof message === 'string') {
        // String direct gebruiken, maar voorkom lege string
        errorText = message.trim() === "" ? "Er is een fout opgetreden (geen details beschikbaar)" : message;
      } else if (message instanceof Error) {
        // Error object verwerken
        errorText = message.message || message.toString();
        
        // Voeg stack toe aan console voor debugging
        console.debug("Stack trace:", message.stack);
      } else if (typeof message === 'object') {
        // Controleer eerst of het een DOM element is
        if (message.nodeType && message.nodeType === 1) {
          // Het is een DOM element
          errorText = "Fout met DOM element: " + (message.tagName || "onbekend element");
          
          // Probeer de tekstinhoud te gebruiken indien beschikbaar
          if (message.innerText || message.textContent) {
            errorText += " - " + (message.innerText || message.textContent);
          }
        } else if (message.message) {
          // Object met message property (zoals server response)
          errorText = message.message.trim() === "" ? 
                      "Er is een fout opgetreden (geen details beschikbaar)" : message.message;
          
          // Als er een code of status property is, voeg dit toe voor meer context
          if (message.code) {
            errorText += ` (code: ${message.code})`;
          } else if (message.status) {
            errorText += ` (status: ${message.status})`;
          }
        } else {
          // Ander type object
          try {
            // Probeer het object naar JSON te converteren als dat mogelijk is
            const jsonString = JSON.stringify(message);
            errorText = jsonString && jsonString !== "{}" ? 
                       jsonString : "Er is een fout opgetreden (leeg object)";
          } catch (e) {
            // Als JSON stringify faalt, gebruik toString met extra controle
            const toStringResult = message.toString();
            errorText = toStringResult !== "[object Object]" ? 
                       toStringResult : "Er is een fout opgetreden (geen details beschikbaar)";
          }
        }
      } else {
        // Voor alle andere datatypes, gebruik toString of cast naar string
        const primitiveString = String(message);
        errorText = primitiveString.trim() !== "" ? 
                   primitiveString : "Er is een fout opgetreden (geen details beschikbaar)";
      }
    } catch (e) {
      // Als er een fout optreedt bij het verwerken van de fout, gebruik een fallback
      console.error("Fout bij verwerken van foutmelding:", e);
      errorText = "Er is een fout opgetreden (foutdetails konden niet worden weergegeven)";
    }
    
    // Zorg ervoor dat de foutmelding nooit leeg of alleen "null" is
    if (!errorText || errorText.trim() === "" || errorText.trim().toLowerCase() === "null") {
      errorText = "Er is een fout opgetreden. Probeer de pagina te vernieuwen of neem contact op met de beheerder.";
    }
    
    // Zet de foutmelding in het element
    errorMessage.textContent = errorText;
    errorContainer.style.display = 'block';
    
    // Verberg na 8 seconden, tenzij het een kritieke fout is
    setTimeout(function() {
      errorContainer.style.display = 'none';
    }, 8000);
  }
  
  /**
   * Toont een notificatie
   */
  function showNotification(message) {
    console.log("Notificatie: " + message);
    
    let notification = document.getElementById('notification');
    
    if (!notification) {
      console.warn("Notification element niet gevonden, nieuw element maken");
      
      notification = document.createElement('div');
      notification.id = 'notification';
      notification.className = 'notification';
      document.body.appendChild(notification);
    }
    
    notification.textContent = message;
    notification.style.display = 'block';
    notification.classList.add('show');
    
    // Verberg na 3 seconden
    setTimeout(function() {
      notification.classList.remove('show');
      notification.style.display = 'none';
    }, 3000);
  }
</script>
